<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:local="*" width="100%" height="100%"
	verticalAlign="top"
	verticalGap="10"
	paddingLeft="10"
	paddingRight="10"
	paddingBottom="10"	
	creationComplete="init()" xmlns:components="commun.components.*" xmlns:ns="library:adobe/flashx/textLayout">
	<mx:Script>
		<![CDATA[
			import flashx.textLayout.events.SelectionEvent;
			import flashx.textLayout.edit.SelectionManager;
			import com.degrafa.geometry.utilities.GeometryUtils;
			import flashx.textLayout.elements.FlowElement;
			import com.hurlant.crypto.symmetric.NullPad;
			import flashx.textLayout.elements.SpanElement;
			import flashx.textLayout.elements.ParagraphElement;
			import commun.Commun;
			import mx.collections.ArrayCollection;
			import flashx.textLayout.conversion.ConversionType;
			import flashx.textLayout.events.ScrollEvent;
        	import mx.events.ScrollEvent;

			
			import mx.controls.Alert;
			import flashx.textLayout.container.IContainerController;
        	import flashx.textLayout.events.CompositionCompletionEvent;
        	import flashx.textLayout.edit.UndoManager;
        	import flashx.textLayout.edit.EditManager;
        	import flashx.textLayout.events.StatusChangeEvent;
        	import flashx.textLayout.elements.InlineGraphicElement;
        	import flashx.textLayout.container.DisplayObjectContainerController;
        	import flashx.textLayout.conversion.TextFilter;
        	import flashx.textLayout.elements.TextFlow;
        	

			
			public static var CHAT:String = "chat";
			public static var ROOM:String = "room";
			[Bindable] public var typeWin : String;
			
			protected var _flow:TextFlow;
			protected var _file_ref:FileReference;
			protected var _img_loader:Loader;
			protected var _text_field_bounds:Rectangle=new Rectangle(0,0,500,100);
			public var nbspan : Number = 0;
			protected function init():void{
				createTextFlow();
			}
			
			public function getLastCharacter(out : XML):String{
				Alert.show(_flow.getLastLeaf().text);
				return "";
			}
			
			protected function createTextFlow():void{
				_flow=new TextFlow();
				var flow_container:Sprite=new Sprite();
				flow_holder.graphics.beginFill(0xFFFFFF);
				flow_holder.graphics.drawRect(0,0,flow_holder.width,flow_holder.height);
				flow_holder.addChild(flow_container);
				var controller:DisplayObjectContainerController=new DisplayObjectContainerController(flow_container,flow_holder.width,flow_holder.height);
				_flow.flowComposer.addController(controller);
	            _flow.interactionManager = new EditManager(new UndoManager());
	            //_flow.interactionManager = new SelectionManager();
	            _flow.addEventListener(CompositionCompletionEvent.COMPOSITION_COMPLETE, composeListener);
	            _flow.addEventListener(SelectionEvent.SELECTION_CHANGE,selectionChange);
	            var p:ParagraphElement = new ParagraphElement();
	            var span:SpanElement = new SpanElement();
	            span.text = "";
	            span.fontSize = 12;
	            span.fontFamily="Tahoma";
	            span.color = "#A9A9A9";
	            p.addChild(span);
	            _flow.addChild(p);
	            _flow.interactionManager.setSelection(0,0);
	            _flow.interactionManager.setFocus();
	            _flow.flowComposer.updateAllContainers();	            
			}
			
			public function addImage(e:MouseEvent):void {
			  _file_ref = new FileReference();
			  _file_ref.addEventListener( Event.SELECT, handleFileSelect,false,0,true );
			   var filter:FileFilter = new FileFilter("Images", "*.jpg;*.gif;*.png");
			  _file_ref.browse([filter]);
			}
			
			private function handleFileSelect(e:Event):void {
			  _file_ref.removeEventListener( Event.SELECT, handleFileSelect );
			  _file_ref.addEventListener(Event.COMPLETE, handleFileOpen,false,0,true );
			  _file_ref.load();
			}

			private function handleFileOpen(e:Event):void {
			  _file_ref.removeEventListener(Event.COMPLETE, handleFileOpen );
			  var data:ByteArray = _file_ref.data as ByteArray;
			  _img_loader=new Loader();			  		  
			  _img_loader.loadBytes(data);
			  _img_loader.contentLoaderInfo.addEventListener(Event.COMPLETE,imageLoadComplete,false,0,true);
			}
			
			public function selectionChange(event : SelectionEvent):void{
				trace("ok");
			}
			
			private function composeListener(e:CompositionCompletionEvent):void {
			  var out:XML = TextFilter.export(_flow, TextFilter.TEXT_LAYOUT_FORMAT, ConversionType.XML_TYPE ) as XML;			  	
			  if(_flow.getLastLeaf().text.search(/:D/)!=-1){
			  		var p : ParagraphElement = _flow.getChildAtIndex(0) as ParagraphElement; 
			  		var span : FlowElement = _flow.getLastLeaf() as FlowElement;
			  		
			  		var leaf:SpanElement = new SpanElement();
            		leaf = SpanElement(_flow.getFirstLeaf());
            		trace(leaf.text);

			  		while(leaf = SpanElement(leaf.getNextLeaf(p)))
		                trace(leaf.text);
					
			  		var newSpan : SpanElement = new SpanElement();
			  		//newSpan.text=span.text.split(4);;
	            	newSpan.fontSize = 12;
	            	newSpan.fontFamily="Tahoma";
	            	newSpan.color="#A9A9A9";
	            	newSpan.text = "test";
	            	p.addChild(newSpan);         	
	            	
	            	p.removeChildAt(0);
	            	_flow.interactionManager.setSelection(0,0);
			  		_flow.flowComposer.updateAllContainers();
			  		_img_loader=new Loader();
			        var image:URLRequest = new URLRequest("assets/emoticones/2s/24/anger.png");			  
			  		_img_loader.load(image);		  
			  		_img_loader.contentLoaderInfo.addEventListener(Event.COMPLETE,imageLoadComplete,false,0,true);
			  		_flow.removeEventListener(CompositionCompletionEvent.COMPOSITION_COMPLETE, composeListener);
			  }			    
			  //_img_loader=new Loader();
			  //var image:URLRequest = new URLRequest("assets/emoticones/2s/24/anger.png");			  
			  //_img_loader.load(image);		  
			  //_img_loader.contentLoaderInfo.addEventListener(Event.COMPLETE,imageLoadComplete,false,0,true);
			  //_flow.removeEventListener(CompositionCompletionEvent.COMPOSITION_COMPLETE, composeListener);
			}
			
			protected function imageLoadComplete(e:Event):void{
			  _img_loader.contentLoaderInfo.removeEventListener(Event.COMPLETE,imageLoadComplete);
			  var bmd:BitmapData=Bitmap(_img_loader.content).bitmapData;
			  var bm:Bitmap=new Bitmap(bmd);
			  EditManager(_flow.interactionManager).insertInlineGraphic(bm,bm.width,bm.height);
			  _flow.interactionManager.setSelection(0,0);
			  _flow.flowComposer.updateAllContainers();
			  _flow.addEventListener(CompositionCompletionEvent.COMPOSITION_COMPLETE, composeListener);
			}
		]]>
	</mx:Script>
	<mx:Style>
		.hboxStyle
			{
			        /*background-color:                       "90deg #FFF0A5 #FFB03B";*/
			        border-bottom-left-radius:              5;
			        border-bottom-right-radius:             5;
			        border-top-left-radius:                 0;
			        border-top-right-radius:                0;
			        borderSkin:                                     ClassReference("com.degrafa.skins.CSSSkin");
			
			        /*border-color:                                   #222222;
			        border-width:                                   "2px 2px 2px 2px";
			        border-alpha:                                   1;*/
			
			} 
	</mx:Style>	
	<mx:VDividedBox width="100%" height="100%">
	<mx:VBox width="100%" height="100%">
	<mx:Canvas width="100%" >
		<mx:VBox x="0" y="0" width="55" height="55" borderStyle="solid" borderColor="#969696" >
			<mx:filters>
		        <mx:DropShadowFilter color="#FFFFFF" blurX="10" blurY="10" distance="0" angle="0"/>
		        <mx:GlowFilter color="#b5b5b5" />
		    </mx:filters>
			<mx:VBox verticalScrollPolicy="off" horizontalScrollPolicy="off" width="53" height="53" borderStyle="solid" borderColor="#FFFFFF" borderThickness="2" >
				<mx:Image width="50" height="50" source="@Embed(source='assets/images/perso.png')" />
			</mx:VBox>
		</mx:VBox>
		<mx:HBox verticalAlign="middle" x="60" y="13" height="20" width="100%" cornerRadius="10" borderStyle="solid" borderColor="#8A8A8A" borderThickness="0" backgroundColor="#8A8A8A" backgroundAlpha="0.2" >
			<mx:HBox height="20" width="150" paddingTop="4" paddingLeft="5" verticalAlign="middle" x="60" y="13"  borderStyle="solid" borderColor="#FFFFFF" cornerRadius="10" backgroundColor="#8A8A8A" backgroundAlpha="0.3" >
				<mx:Label color="#FFFFFF" text="User name" fontFamily="Vegur_R" fontSize="12">
					<mx:filters>			            
			            <mx:GlowFilter color="#8A8A8A" />		            
			        </mx:filters>
				</mx:Label>
			</mx:HBox>
			<mx:Spacer width="100%" />
			<mx:HBox horizontalAlign="center" height="20" width="50" paddingTop="4" verticalAlign="middle" x="60" y="13"  borderStyle="solid" borderColor="#FFFFFF" cornerRadius="10" backgroundColor="#8A8A8A" backgroundAlpha="0.3" >
				<mx:Label color="#FFFFFF" text="18:06" fontFamily="Vegur_R" fontSize="12">
					<mx:filters>			            
			            <mx:GlowFilter color="#8A8A8A" />		            
			        </mx:filters>
				</mx:Label>
			</mx:HBox>
		</mx:HBox>
		<mx:VBox verticalGap="0" paddingLeft="8" verticalAlign="middle" dropShadowEnabled="true" shadowDistance="0" width="100%" height="60" x="40" y="40" borderStyle="solid" borderColor="#FFFFFF" cornerRadius="5" backgroundColor="#FFFFFF">
			<mx:HBox width="100%" height="20" verticalAlign="middle">
				<mx:Image source="@Embed(source='assets/images/OrangeIcone.png')">
					<mx:filters>
			            <mx:DropShadowFilter color="#FFFFFF" blurX="10" blurY="10" distance="0" angle="0"/>
			            <mx:GlowFilter color="#FFFFFF" />		            
			        </mx:filters>
				</mx:Image>
				<mx:Text color="#8A8A8A" text=""/>
			</mx:HBox>
			<mx:HBox width="100%" height="20" verticalAlign="middle">
				<mx:Image source="@Embed(source='assets/images/OrangeIcone.png')">
					<mx:filters>
			            <mx:DropShadowFilter color="#FFFFFF" blurX="10" blurY="10" distance="0" angle="0"/>
			            <mx:GlowFilter color="#FFFFFF" />		            
			        </mx:filters>
				</mx:Image>
				<mx:Text color="#8A8A8A" text=""/>
			</mx:HBox>			
		</mx:VBox>
	</mx:Canvas>
	
	<mx:Canvas width="100%" height="100%">
		<mx:VBox x="0" y="0" width="55" height="55" borderStyle="solid" borderColor="#969696" >
			<mx:filters>
		        <mx:DropShadowFilter color="#FFFFFF" blurX="10" blurY="10" distance="0" angle="0"/>
		        <mx:GlowFilter color="#b5b5b5" />
		    </mx:filters>
			<mx:VBox verticalScrollPolicy="off" horizontalScrollPolicy="off" width="53" height="53" borderStyle="solid" borderColor="#FFFFFF" borderThickness="2" >
				<mx:Image width="50" height="50" source="@Embed(source='assets/images/perso.png')" />
			</mx:VBox>
		</mx:VBox>
		<mx:HBox verticalAlign="middle" x="60" y="13" height="20" width="100%" cornerRadius="10" borderStyle="solid" borderColor="#8A8A8A" borderThickness="0" backgroundColor="#8A8A8A" backgroundAlpha="0.2" >
			<mx:HBox height="20" width="150" paddingTop="4" paddingLeft="5" verticalAlign="middle" x="60" y="13"  borderStyle="solid" borderColor="#FFFFFF" cornerRadius="10" backgroundColor="#8A8A8A" backgroundAlpha="0.5" >
				<mx:Label color="#FFFFFF" text="User name" fontFamily="Vegur_R" fontSize="12">
					<mx:filters>
			            <mx:DropShadowFilter color="#8A8A8A" blurX="10" blurY="10" distance="0" angle="0"/>
			            <mx:GlowFilter color="#8A8A8A" />		            
			        </mx:filters>
				</mx:Label>
			</mx:HBox>
			<mx:Spacer width="100%" />
			<mx:HBox horizontalAlign="center" height="20" width="50" paddingTop="4" verticalAlign="middle" x="60" y="13"  borderStyle="solid" borderColor="#FFFFFF" cornerRadius="10" backgroundColor="#8A8A8A" backgroundAlpha="0.5" >
				<mx:Label color="#FFFFFF" text="18:06" fontFamily="Vegur_R" fontSize="12">
					<mx:filters>
			            <mx:DropShadowFilter color="#8A8A8A" blurX="10" blurY="10" distance="0" angle="0"/>
			            <mx:GlowFilter color="#8A8A8A" />		            
			        </mx:filters>
				</mx:Label>
			</mx:HBox>
		</mx:HBox>
		<mx:VBox verticalGap="0" paddingLeft="8" verticalAlign="middle" dropShadowEnabled="true" shadowDistance="0" width="100%" height="60" x="40" y="40" borderStyle="solid" borderColor="#FFFFFF" cornerRadius="5" backgroundColor="#FFFFFF">
			<mx:HBox width="100%" height="20" verticalAlign="middle">
				<mx:Image width="5" height="5" source="@Embed(source='assets/images/GreyIcone.png')">
					<mx:filters>
			            <mx:DropShadowFilter color="#FFFFFF" blurX="10" blurY="10" distance="0" angle="0"/>
			            <mx:GlowFilter color="#FFFFFF" />		            
			        </mx:filters>
				</mx:Image>
				<mx:Text color="#FF6600" text=""/>
			</mx:HBox>
			<mx:HBox width="100%" height="20" verticalAlign="middle">
				<mx:Image source="@Embed(source='assets/images/GreyIcone.png')">
					<mx:filters>
			            <mx:DropShadowFilter color="#FFFFFF" blurX="10" blurY="10" distance="0" angle="0"/>
			            <mx:GlowFilter color="#FFFFFF" />		            
			        </mx:filters>
				</mx:Image>
				<mx:Text color="#FF6600" text=""/>
			</mx:HBox>			
		</mx:VBox>
	</mx:Canvas>
	<mx:Button label="add image" click="addImage(event);" x="100" y="20" /> 
	</mx:VBox>
		
	
	<mx:VBox minHeight="80" verticalGap="0" width="100%" height="80" borderStyle="solid" borderThickness="0" backgroundColor="#FFFFFF" cornerRadius="5">		
		<mx:filters>
            <mx:DropShadowFilter inner="true" color="#A8A8A8" blurX="10" blurY="10" distance="0" angle="0"/>            		            
        </mx:filters>        
        <mx:HBox paddingLeft="10" paddingRight="10" paddingTop="10" verticalAlign="middle" backgroundAlpha="0" width="100%" height="100%" horizontalAlign="right" >        	
        	<mx:TextArea focusEnabled="false" id="flow_holder" width="100%" height="100%" focusAlpha="0" borderStyle="none">
        		
        
        	</mx:TextArea>        	        	
        	<mx:Image id="btnSend" mouseOver="btnSend.alpha = 0.8" mouseOut="btnSend.alpha = 0.5" buttonMode="true" useHandCursor="true" alpha="0.5" source="@Embed(source='assets/images/IM.png')"  />	
        </mx:HBox>
        <mx:HBox styleName="hboxStyle" alpha="0.5" backgroundColor="#A8A8A8" height="20" width="100%"/>        
	</mx:VBox>
	</mx:VDividedBox>
</mx:VBox>
