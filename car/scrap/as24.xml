<?xml version="1.0" encoding="UTF-8"?>
 
<config charset="ISO-8859-1">
 
    <var-def name="repOut">C:/scraping/files/</var-def>
	<var-def name="repImage">as24pic/</var-def>
    <var-def name="maxLoop">1</var-def>
    <var-def name="startUrl">http://www.autoscout24.fr/ListGN.aspx</var-def>
    
     <file action="write" path="${repOut}as24_${sys.date()}${sys.time()}.pa" charset="UTF-8">                        
		<template>
	        <![CDATA[ <annonces date="${sys.datetime("dd.MM.yyyy")}"> ]]>
	    </template>
    
		<while  condition="true"
			index="i" 
	        maxloops="${maxLoop}"
	        empty="empty">						
			
			<loop item="annonceUrl" index="j">
				<list>
					  <xpath expression="(//links/link/@href)">
							<jsas24-to-xml>						
							    <xpath expression="(//body/form[@name='aspnetForm']/script[@type='text/javascript'])[2]">
							        <html-to-xml>
						                <http url="${startUrl}" method="get">
						                	<http-param name="vis">1</http-param>
									        <http-param name="state">A</http-param>
									        <http-param name="pricefrom">1000</http-param>
									        <http-param name="cy">F</http-param>
									        <http-param name="maxresults">500</http-param>
									        <http-param name="results">20</http-param>
									        <http-param name="ustate">N,U</http-param>
									        <http-param name="sort">price</http-param>
									        <http-param name="pool">1</http-param>
									        <http-param name="zipc">F</http-param>
									        <http-param name="page">${i}</http-param>
						                </http>	
						            </html-to-xml>
							    </xpath>
							</jsas24-to-xml>    
					 </xpath>					 
	            </list>		            
	            <body>
						<![CDATA[ <annonce> ]]>   
						<xquery>							
							<xq-param name="doc">
		                       <xpath expression="//form[@name='aspnetForm']">
		                       		<var-def name="htmlContentAnnonce">
								        <html-to-xml>
					                        <http url="${annonceUrl}"/>
					                    </html-to-xml>
					                </var-def>
							    </xpath> 
		                    </xq-param>		                    			            					
							<xq-expression><![CDATA[
		                        declare variable $doc as node() external;
	                        
		                        let $title := data($doc//div[@class='container']/div[@class='content-area']/div[@id='dialog-imagesslideshow']/div[@class='dialog-wrap']/div[@class='dialog-body imagesslideshow-body']/div[@id='dialog-content']/div[@id='imagesslideshow-subtitle']/div[@class='slideshow_makemodel'])
								let $prix := data($doc//div[@class='container']/div[@class='content-area']/div[@id='dialog-imagesslideshow']/div[@class='dialog-wrap']/div[@class='dialog-body imagesslideshow-body']/div[@id='dialog-content']/div[@id='imagesslideshow-subtitle']/div[@class='slideshow_price'])
								let $url := data($doc//@action)
								let $adresse := data($doc//div[@class='container']/div[@class='content-area']/div[@class='detail-content']/div[@class='box-container']/div[@class='wrap']/div[@class='main']/div[@id='detailLeft']/div[@class='contact-container']/div[@class='maps-location']/table/tbody/tr/td[@class='maps-data']/div)
								let $annee := data($doc//div[@class='container']/div[@class='content-area']/div[@class='detail-content']/div[@class='box-container']/div[@class='wrap']/div[@class='main']/div[@id='detailRight']/div[@class='articleGeneralDataContainer']/table/tbody/tr[@id='ctl00_ctl00_decoratedArea_contentArea_articleGeneralData_firstRegRow']/td[@class='c2'])
								let $km := data($doc//div[@class='container']/div[@class='content-area']/div[@class='detail-content']/div[@class='box-container']/div[@class='wrap']/div[@class='main']/div[@id='detailRight']/div[@class='articleGeneralDataContainer']/table/tbody/tr[@id='ctl00_ctl00_ctl00_ctl00_decoratedArea_contentArea_articleGeneralData_mileageRow']/td[@class='c2'])
								let $energie := data($doc//div[@class='container']/div[@class='content-area']/div[@class='detail-content']/div[@class='box-container']/div[@class='wrap']/div[@class='main']/div[@id='detailRight']/div[@class='articleGeneralDataContainer']/table/tbody/tr[@id='ctl00_ctl00_ctl00_ctl00_ctl00_ctl00_decoratedArea_contentArea_articleGeneralData_fuelRow']/td[@class='c2'])
								
								
								let $owner := data($doc//div[@class='container']/div[@class='content-area']/div[@class='detail-content']/div[@class='box-container']/div[@class='wrap']/div[@class='main']/div[@id='detailLeft']/div[@class='contact-container']/div[@class='contact-data-separator contact-data']/p[2])
								let $message := data($doc//div[@class='container']/div[@class='content-area']/div[@class='detail-content']/div[@class='box-container']/div[@class='wrap']/div[@class='main']/div[@id='detailRight']/div[@class='description-text'])
								let $phone1 := data($doc//div[@class='container']/div[@class='content-area']/div[@class='detail-content']/div[@class='box-container']/div[@class='wrap']/div[@class='main']/div[@id='detailLeft']/div[@class='contact-container']/div[@class='contact-data-separator1']/div/p[1])
								let $phone2 := data($doc//div[@class='container']/div[@class='content-area']/div[@class='detail-content']/div[@class='box-container']/div[@class='wrap']/div[@class='main']/div[@id='detailLeft']/div[@class='contact-container']/div[@class='contact-data-separator1']/div/p[2])
								let $vitesse := data($doc//tr[@id='ctl00_ctl00_decoratedArea_contentArea_articleMoreDetailsData_gearingTypeRow']/td[@class='c2']/span)
		                        return
		                           		<infos>
			                                <title>{data($title)}</title>			                                
			                                <price>{data($prix)}</price>	
			                                <annee>{data($annee)}</annee>
			                                <km>{data($km)}</km>
			                                <energie>{data($energie)}</energie>
			                                <url>http://www.autoscout24.fr/{data($url)}</url>		                                
			                                <source>www.autoscout24.fr</source>
			                                <adresse>{data($adresse)}</adresse>
			                                <pays>FR</pays>
			                                <pf>NONE</pf>
			                                <vitesse>{data($vitesse)}</vitesse>		
			                                <owner>{data($owner)}</owner>
			                                <message>{data($message)}</message>
			                                <phones>
			                                	<phone>{data($phone1)}</phone>
			                                	<phone>{data($phone2)}</phone>			                                	
			                                </phones>
		                                </infos>		                           
		                    ]]></xq-expression>
	                	</xquery>
	                	<xquery>							
							<xq-param name="doc">
		                       <xpath expression="//form[@name='aspnetForm']">
							        <var name="htmlContentAnnonce"/>
							    </xpath> 
		                    </xq-param>		                    			            					
							<xq-expression><![CDATA[
		                        declare variable $doc as node() external;
	                        

								let $prix := data($doc//div[@class='container']/div[@class='content-area']/div[@id='dialog-imagesslideshow']/div[@class='dialog-wrap']/div[@class='dialog-body imagesslideshow-body']/div[@id='dialog-content']/div[@id='imagesslideshow-subtitle']/div[@class='slideshow_price'])
								let $annee := data($doc//div[@class='container']/div[@class='content-area']/div[@class='detail-content']/div[@class='box-container']/div[@class='wrap']/div[@class='main']/div[@id='detailRight']/div[@class='articleGeneralDataContainer']/table/tbody/tr[@id='ctl00_ctl00_decoratedArea_contentArea_articleGeneralData_firstRegRow']/td[@class='c2'])
								let $km := data($doc//div[@class='container']/div[@class='content-area']/div[@class='detail-content']/div[@class='box-container']/div[@class='wrap']/div[@class='main']/div[@id='detailRight']/div[@class='articleGeneralDataContainer']/table/tbody/tr[@id='ctl00_ctl00_decoratedArea_contentArea_articleGeneralData_mileageRow']/td[@class='c2'])
								let $energie := data($doc//tr[@id='ctl00_ctl00_decoratedArea_contentArea_articleGeneralData_fuelRow']/td[@class='c2']/div[@class='c2-sub'])

		                        return
		                           		<details>			                                
			                                <detail type="Prix :">{data($prix)}</detail>	
			                                <detail type="Année-modèle :">{data($annee)}</detail>
			                                <detail type="Kilométrage :">{data($km)}</detail>
			                                <detail type="Carburant :">{data($energie)}</detail>			                                
		                                </details>		                           
		                    ]]></xq-expression>
	                	</xquery>
	                	<![CDATA[ <images> ]]>
	                	<loop item="imageURL" index="k">
		                	<list>
		                			<xpath expression="(//images/image/@href)">
											<asimage-to-xml>						
											    <xpath expression="(//form[@name='aspnetForm']/div[@class='container']/div[@class='content-area']/script[@language='javascript'])[1]">
											        <var name="htmlContentAnnonce"/>
											    </xpath>
											</asimage-to-xml>    
									 </xpath>	
		                	</list>
		                	<body>
			                		<template><![CDATA[ <image href="${imageURL}"/> ]]></template>
			                		<!--<empty>
						                <file action="write" path="${repOut}${repImage}${imageURL.toString().substring(imageURL.toString().lastIndexOf('/')+1, imageURL.toString().lastIndexOf('.'))}.jpg" type="binary">
						                    <http url='${imageURL}'/>
						                </file>
						            </empty>-->
		                	</body>
	                	</loop>				
	                	<![CDATA[ </images> ]]>
	                	<![CDATA[ <accessoires> ]]>
	                	<loop item="acc" index="k">
		                	<list>										
							    <xpath expression="(//form[@name='aspnetForm']/div[@class='container']/div[@class='content-area']/div[@class='detail-content']/div[@class='box-container']/div[@class='wrap']/div[@class='main']/div[@id='detailRight']/div[@class='equipments']/div[@class='equipment-list']/div[@class='equipment-left']/ul/li)">
							        <var name="htmlContentAnnonce"/>
							    </xpath>
		                	</list>
		                	<body>	                		
			                		<template><![CDATA[ <accessoire>${acc.toString().replaceAll("<li>","").replaceAll("</li>","")}</accessoire> ]]></template>
		                	</body>
	                	</loop>		
	                	<loop item="acc" index="k">
		                	<list>										
							    <xpath expression="(//form[@name='aspnetForm']/div[@class='container']/div[@class='content-area']/div[@class='detail-content']/div[@class='box-container']/div[@class='wrap']/div[@class='main']/div[@id='detailRight']/div[@class='equipments']/div[@class='equipment-list']/div[@class='equipment-right']/ul/li)">
							        <var name="htmlContentAnnonce"/>
							    </xpath>
		                	</list>
		                	<body>	                		
			                		<template><![CDATA[ <accessoire>${acc.toString().replaceAll("<li>","").replaceAll("</li>","")}</accessoire> ]]></template>
		                	</body>
	                	</loop>			
	                	<![CDATA[ </accessoires> ]]>
	                	<![CDATA[ </annonce> ]]>   	                		                   
	            </body>
			</loop>				
		</while>		
		<![CDATA[ </annonces> ]]>    
	</file>			
</config>