<?xml version="1.0" encoding="UTF-8"?>
 
<config charset="ISO-8859-1">
 
    <var-def name="repOut">C:/scraping/files/</var-def>
    <var-def name="maxLoop">10</var-def>
    <var-def name="startUrl">http://www.autoscout24.fr/ListGN.aspx</var-def>
    
     <file action="write" path="${repOut}as24_${sys.date()}${sys.time()}.pa" charset="UTF-8">                        
		<template>
	        <![CDATA[ <annonces date="${sys.datetime("dd.MM.yyyy")}"> ]]>
	    </template>
    
		<while  condition="true"
			index="i" 
	        maxloops="${maxLoop}"
	        empty="empty">						
			
			<loop item="annonceUrl" index="j">
				<list>
					  <xpath expression="(//links/link/@href)">
							<jsas24-to-xml>						
							    <xpath expression="(//body/form[@name='aspnetForm']/script[@type='text/javascript'])[2]">
							        <html-to-xml>
						                <http url="${startUrl}" method="get">
						                	<http-param name="vis">1</http-param>
									        <http-param name="state">A</http-param>
									        <http-param name="pricefrom">1000</http-param>
									        <http-param name="cy">F</http-param>
									        <http-param name="maxresults">500</http-param>
									        <http-param name="results">20</http-param>
									        <http-param name="ustate">N,U</http-param>
									        <http-param name="sort">price</http-param>
									        <http-param name="pool">1</http-param>
									        <http-param name="zipc">F</http-param>
									        <http-param name="page">${i}</http-param>
						                </http>	
						            </html-to-xml>
							    </xpath>
							</jsas24-to-xml>    
					 </xpath>					 
	            </list>		            
	            <body>
					<loop item="annonceItem" index="k">                	
						<list>
							<xpath expression="//div[@class='content-area']">
						        <html-to-xml>
				                    <http url="${annonceUrl}"/>
				                </html-to-xml>
						    </xpath>						
						</list>
						<body>
							<xquery>
								<xq-param name="doc">
			                       <var name="${annonceItem}"/>				                   
			                    </xq-param>		                    			            					
								<xq-expression><![CDATA[
			                        declare variable $doc as node() external;
			                        
			                        let $title := data($doc//div[@id='ContainerMain']/div[@class='lbcAdContainer']/span[@class='ad_links']/h1)
			                        let $phone := data($doc//div[@class='lbcAdContainer']/div[@class='lbcAdOptions']/div[@class='lbcAd_option_box']/div/div[@style='max-height:50px;']/div[@style='float:left;width:24px']/img/@src)
			                        let $details := data($doc//div[@class='lbcAdParams']/span[@class='ad_details']/strong)			                        
			                        let $details := data($doc//div[@class='lbcAdParams']/span[@class='ad_details']/strong)			                        			                        
			                        let $ville := data($doc//div[@class='lbcAdParams']/span[@class='ad_details_400']/strong)			                        			                        			                        
			                        let $vitesse := data($doc//div[@class='lbcAdParams']/span[@class='ad_details_200']/strong)			                        			                        			                        			                        
			                        let $annonce := data($doc//head/meta[@name='description']/@content)			                        			                        			                        			                        			                        
			                        let $url := data($doc//head/link[@rel='canonical']/@href)	
			                        let $owner := data($doc//div[@class='lbcAdContainer']/a[@rel='nofollow'])		                        			                        			                        			                        			                       
			                        return
				                           		<annonce>
					                                <title>{data($title)}</title>
					                                <phone>{data($phone)}</phone>				                                
					                                <price>{data($details[1])}</price>				                                
					                                <annee>{data($details[2])}</annee>				                                				                                				                                
					                                <km>{data($details[3])}</km>				                                				                                
					                                <energie>{data($details[4])}</energie>				                                				                                				                                
					                                <ville>{data($ville)}</ville>				                                				                                				                                				                                
					                                <vitesse>{data($vitesse)}</vitesse>				                                				                                				                                				                                				                                
					                                <message>{data($annonce)}</message>				                                
					                                <source>www.leboncoin.fr</source>
					                                <url>{data($url)}?ca=12_s</url>
					                                <owner>{data($owner)}</owner>
				                                </annonce>
			                           
			                    ]]></xq-expression>
			                </xquery>
						</body>
					</loop>
	            </body>
			</loop>				
		</while>		
		<![CDATA[ </annonces> ]]>    
	</file>			
</config>