<?xml version="1.0" encoding="UTF-8"?>
 
<config charset="ISO-8859-1">
 
    <var-def name="repOut">C:/scraping/files/</var-def>
    <var-def name="repImage">vampic/</var-def>
    <var-def name="repPhone">phone/</var-def>
    <var-def name="maxLoop">1</var-def>
    <var-def name="startUrl">http://www.voitureaumaroc.com/auto/recents.asp</var-def>
    
     <file action="write" path="${repOut}vam_par_${sys.date()}${sys.time()}.pa" charset="UTF-8">                        
		<template>
	        <![CDATA[ <annonces date="${sys.datetime("dd.MM.yyyy")}"> ]]>
	    </template>
    
		<while  condition="true"
			index="i" 
	        maxloops="${maxLoop}"
	        empty="empty">						
			<loop item="annonceUrl" index="j">
				<list>
				    <xpath expression="(//body/form[@class='compare']/table[@class='maintable']/tbody/tr[1]/td[3]/table/tbody/tr[1]/td[1]/table[@class='srlcomplinesbot']/tbody/tr[1]/td[3]/strong/a/@href)">
				        <html-to-xml>
			                <http url="${startUrl}?ob=l_d" method="get">						                	
						        <http-param name="page">${i}</http-param>						        					        						        
			                </http>	
			            </html-to-xml>
				    </xpath>							
	            </list>		            
	            <body>
	            	<![CDATA[ <annonce> ]]>  	            		
	            	<xquery>							
							<xq-param name="doc">
		                       <xpath expression="//body">
		                       		<var-def name="htmlContentAnnonce">
								        <html-to-xml>
						                    <http url="http://www.voitureaumaroc.com${org.apache.commons.httpclient.util.URIUtil.encodeQuery(annonceUrl.toString())}"/>
						                </html-to-xml>
					                </var-def>
							    </xpath> 
		                    </xq-param>	
		                    <xq-param name="url" type="string"><template>http://www.voitureaumaroc.com${org.apache.commons.httpclient.util.URIUtil.encodeQuery(annonceUrl.toString())}</template></xq-param>	                    			            					
							<xq-expression><![CDATA[
		                        declare variable $doc as node() external;
	                        	declare variable $url as xs:string external;
	                        	
		                        let $title := data($doc//table[2]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[1]/table[2]/tbody/tr[1]/td[1]/h3)
								let $message := data($doc//table[2]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[1]/table[2]/tbody/tr[16]/td[1])
								let $phone := data($doc//table[2]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[1]/table[2]/tbody/tr[14]/td[1]/strong)
								let $vitesse := data($doc//table[2]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[1]/table[2]/tbody/tr[3]/td[2])
								
								
								return 
									<infos>
										<phones>
		                                	<phone>{data($phone)}</phone>				                                
		                                </phones>
										<title>{data($title)}</title>
										<adresse></adresse>				                                				                                				                                				                                
		                                <vitesse>{data($vitesse)}</vitesse>	
										<message>{data($message)}</message>
										<source>www.voitureaumaroc.com</source>
		                                <url>{data($url)}</url>
		                                <owner></owner>
										<pays>MA</pays>			                                                               
		                                <pf>NONE</pf>
									</infos>		                           
		                    ]]></xq-expression>
                	</xquery>
	                <loop item="detail" index="d">
	            		<list>
	            			<xpath expression="//body">
	            				<var name="htmlContentAnnonce"/>			                    
	            			</xpath>		
	            		</list>
	            		<body>	
	            			<xquery>
								<xq-param name="doc2">
			                       <html-to-xml>
				                        <var name="detail"/>
				                    </html-to-xml> 
			                    </xq-param>		                    			            					
								<xq-expression><![CDATA[
			                        declare variable $doc2 as node() external;
			                        
			                        let $prix := data($doc2//table[2]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[1]/table[2]/tbody/tr[1]/td[1]/h3)
									let $annee := data($doc2//table[2]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[1]/table[2]/tbody/tr[1]/td[1]/h3)
									let $km := data($doc2//table[2]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[1]/table[2]/tbody/tr[3]/td[1])
									let $energie := data($doc2//table[2]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[1]/table[2]/tbody/tr[3]/td[3])
	
			                        return
			                           		<details>			                                
				                                <detail type="Prix :">{data($prix)}</detail>	
				                                <detail type="Année-modèle :">{data($annee)}</detail>
				                                <detail type="Kilométrage :">{data($km)}</detail>
				                                <detail type="Carburant :">{data($energie)}</detail>			                                
			                                </details>				                                				                                			                                
			                           
			                    ]]></xq-expression>
			                </xquery>
			                <![CDATA[ <images> ]]>
		                	<loop item="imageURL" index="k">
			                	<list>
			                			<xpath expression="(//table[2]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[1]/table[1]/tbody/tr[1]/td/div[@class='c1'])/a/@href">
												<html-to-xml>
							                        <var name="detail"/>
							                    </html-to-xml>    
										 </xpath>	
			                	</list>
			                	<body>
				                		<template><![CDATA[ <image href="http://www.voitureaumaroc.com${org.apache.commons.httpclient.util.URIUtil.encodeQuery(imageURL.toString())}"/> ]]></template>
				                		<!--<empty>
							                <file action="write" path="${repOut}${repImage}${imageURL.toString().substring(imageURL.toString().lastIndexOf('/')+1, imageURL.toString().lastIndexOf('.'))}.jpg" type="binary">
							                    <http url='${imageURL}'/>
							                </file>
							            </empty>-->
			                	</body>
		                	</loop>				
		                	<![CDATA[ </images> ]]> 
		                	<![CDATA[ <accessoires> ]]>
		                	<while  condition="true"
								index="loopIndex" 
						        maxloops="7"
						        empty="empty">	
			                	<loop item="acc" index="k">
				                	<list>										
									    <xpath expression="(//table[2]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[2]/table[1]/tbody/tr[1]/td[1]/table[2]/tbody/tr[${loopIndex}+${6}]/td)">
												<html-to-xml>
							                        <var name="detail"/>
							                    </html-to-xml>    
										 </xpath>
				                	</list>
				                	<body>	
				                			<empty>
				                				<var-def name="condContains">
				                					<template><![CDATA[ ${acc.toString().contains("check.")} ]]></template>
				                				</var-def>
				                			</empty>
				                			<case>
										        <if condition="${condContains}">
										            <template><![CDATA[ <accessoire>${acc.toString().replaceAll("(\\<)(td)(\\s)*(bgcolor)(\\=)([^0-9])*(\\/)(\\>)", "").replaceAll("(\\<)([^0-9])*","")}</accessoire> ]]></template>
										        </if>										        
										    </case>					                		
				                	</body>
			                	</loop>
		                	</while>		                		
		                	<![CDATA[ </accessoires> ]]>
	            		</body>	
	            	</loop>	            	
                	<![CDATA[ </annonce> ]]>               		                                   		                   
	            </body>
	        </loop>					
		</while>		
		<![CDATA[ </annonces> ]]>    
	</file>			
</config>