<?xml version="1.0" encoding="UTF-8"?>
 
<config charset="ISO-8859-1">
 
    <var-def name="repOut">C:/scraping/files/</var-def>
    <var-def name="repImage">motmapic/</var-def>
    <var-def name="repPhone">phone/</var-def>
    <var-def name="maxLoop">1</var-def>
    <var-def name="startUrl">http://www.moteur.ma/?moteur=achat-voiture-occasion</var-def>
    
     <file action="write" path="${repOut}motma_${sys.date()}${sys.time()}.pa" charset="UTF-8">                        
		<template>
	        <![CDATA[ <annonces date="${sys.datetime("dd.MM.yyyy")}"> ]]>
	    </template>
    
		<while  condition="true"
			index="i" 
	        maxloops="${maxLoop}"
	        empty="empty">						
			<loop item="annonceUrl" index="j">			
				<list>
				    <xpath expression="(//table[@id='bloc_occasion']/tbody/tr[1]/td[2]/a/@href)">
				        <html-to-xml>
			                <http url="${startUrl}" method="get">						                	
						        <http-param name="page">${i}</http-param>						        
			                </http>	
			            </html-to-xml>
				    </xpath>
	            </list>		            	            
	            <body>
	            	<![CDATA[ <annonce> ]]>	            	
		            <empty>
	            		<loop item="messageContent" index="mmC">
							<list>
				            	<xpath expression="//font[@color='#333333'][@size='2']">
			                   		<var-def name="htmlContentAnnonce">
								        <html-to-xml>
						                    <http url="http://www.moteur.ma${org.apache.commons.httpclient.util.URIUtil.encodeQuery(annonceUrl.toString())}"/>
						                </html-to-xml>
					                </var-def>
							    </xpath>
							</list>
						    <body>
						    	<empty>
	                				<var-def name="condEqual">
	                					<template><![CDATA[ ${mmC.toString().equals("2")} ]]></template>
	                				</var-def>
	                			</empty>
						    	<case>						    		
						    		<if condition="${condEqual}">
						    			<var-def name="message"><template>${messageContent}</template></var-def>
						    		</if>
						    	</case>
						    </body>								
						</loop>
	           		</empty>	
	           		<empty>
	            		<loop item="vitesseContent" index="vitesseC">
							<list>
				            	<xpath expression="//table[@id='tableau_bloc_orange'][1]/tbody/tr[2]/td[2]/table/tbody/tr">
			                   		<var name="htmlContentAnnonce"/>
							    </xpath>
							</list>
						    <body>						    	
                				<var-def name="condEqual">
                					<template><![CDATA[ ${vitesseContent.toString().contains("vitesse")} ]]></template>
                				</var-def>	                			
						    	<case>						    		
						    		<if condition="${condEqual}">						    			
						    			<var-def name="vitesse">
						    				<xpath expression="//strong">
						    					<html-to-xml>
								                    <var name="vitesseContent" />
								                </html-to-xml>
						    				</xpath>					    			
						    			</var-def>
						    			
						    		</if>
						    	</case>
						    </body>								
						</loop>
	           		</empty>
	           		<empty>
	            		<loop item="anneeContent" index="anneeC">
							<list>
				            	<xpath expression="//table[@id='tableau_bloc_orange'][1]/tbody/tr[2]/td[2]/table/tbody/tr">
			                   		<var name="htmlContentAnnonce"/>
							    </xpath>
							</list>
						    <body>						    	
                				<var-def name="condEqual">
                					<template><![CDATA[ ${anneeContent.toString().contains("Année")} ]]></template>
                				</var-def>	                			
						    	<case>						    		
						    		<if condition="${condEqual}">						    			
						    			<var-def name="annee">
						    				<xpath expression="//strong">
						    					<html-to-xml>
								                    <var name="anneeContent" />
								                </html-to-xml>
						    				</xpath>					    			
						    			</var-def>
						    			
						    		</if>
						    	</case>
						    </body>								
						</loop>
					</empty>
	            	<xquery>							
							<xq-param name="doc">								
		                       <xpath expression="//body">
		                       		<var name="htmlContentAnnonce"/>		
							    </xpath> 
		                    </xq-param>	
		                    <xq-param name="url" type="string"><template>http://www.moteur.ma${org.apache.commons.httpclient.util.URIUtil.encodeQuery(annonceUrl.toString())}</template></xq-param>	                    			            					
		                    <xq-param name="message" type="string"><template>${message}</template></xq-param>	                    			            					
		                    <xq-param name="vitesse" type="string"><template><![CDATA[ ${vitesse.toString().replaceAll("<strong>","").replaceAll("</strong>","")} ]]></template></xq-param>	                    			            					
							<xq-expression><![CDATA[
		                        declare variable $doc as node() external;
	                        	declare variable $url as xs:string external;
	                        	declare variable $message as xs:string external;
	                        	declare variable $vitesse as xs:string external;
	                        	
		                        let $title := data($doc//table[@id='tableau_bloc_bleu']/tbody/tr[1]/td[3]/div/strong/font)								
								let $phone := data($doc//font[@color='#FF6600'][@size='4'])
								
								
								
								return 
									<infos>
										<phones>
		                                	<phone>{data($phone)}</phone>				                                
		                                </phones>
										<title>{data($title)}</title>
										<adresse></adresse>				                                				                                				                                				                                
		                                <vitesse>{data($vitesse)}</vitesse>	
										<message>{data($message)}</message>
										<source>www.moteur.ma</source>
		                                <url>{data($url)}</url>
		                                <owner></owner>
										<pays>MA</pays>			                                                               
		                                <pf>NONE</pf>
									</infos>		                           
		                    ]]></xq-expression>
                	</xquery>
                	<xquery>							
						<xq-param name="doc">
	                       <xpath expression="//body">
						        <var name="htmlContentAnnonce"/>
						    </xpath> 
	                    </xq-param>		
	                    <xq-param name="annee" type="string"><template><![CDATA[ ${annee.toString().replaceAll("<strong>","").replaceAll("</strong>","")} ]]></template></xq-param>	                    			            					                    			            					
						<xq-expression><![CDATA[
	                        declare variable $doc as node() external;
                        	declare variable $annee as xs:string external;

							let $prix := data($doc//table[@id='tableau_bloc_bleu']/tbody/tr[2]/td[2]/table/tbody/tr[1]/td[1]/table/tbody/tr[5]/td[1]/font[1])
							let $km := data($doc//table[@id='tableau_bloc_bleu']/tbody/tr[2]/td[2]/table/tbody/tr[1]/td[1]/table/tbody/tr[6]/td[1]/font[1])
							let $energie := data($doc//table[@id='tableau_bloc_bleu']/tbody/tr[2]/td[2]/table/tbody/tr[1]/td[1]/table/tbody/tr[6]/td[1]/font[2])

	                        return
	                           		<details>			                                
		                                <detail type="Prix :">{data($prix)}</detail>	
		                                <detail type="Année-modèle :">{data($annee)}</detail>
		                                <detail type="Kilométrage :">{data($km)}</detail>
		                                <detail type="Carburant :">{data($energie)}</detail>			                                
	                                </details>		                           
	                    ]]></xq-expression>
                	</xquery>
                	<![CDATA[ <images> ]]>
                	<loop item="imageURL" index="k">
	                	<list>
	                			<xpath expression="(//table[@id='tableau_thumbs']/tbody/tr/td/table/tbody/tr/td/a/img/@src)">
										<var name="htmlContentAnnonce"/>								
								</xpath>	
	                	</list>
	                	<body>
		                		<template><![CDATA[ <image href="http://www.moteur.ma${imageURL}"/> ]]></template>
		                		<!--<empty>
					                <file action="write" path="${repOut}${repImage}${imageURL.toString().substring(imageURL.toString().lastIndexOf('/')+1, imageURL.toString().lastIndexOf('.'))}.jpg" type="binary">
					                    <http url='${imageURL}'/>
					                </file>
					            </empty>-->
	                	</body>
                	</loop>				
                	<![CDATA[ </images> ]]>
                	<empty>
	            		<loop item="accContent" index="accC">
							<list>
				            	<xpath expression="//font[@color='#333333'][@size='2']">
			                   		<var name="htmlContentAnnonce"/>
							    </xpath>
							</list>
						    <body>
						    	<empty>
	                				<var-def name="condEqual">
	                					<template><![CDATA[ ${accC.toString().equals("1")} ]]></template>
	                				</var-def>
	                			</empty>
						    	<case>						    		
						    		<if condition="${condEqual}">
						    			<var-def name="accessoires"><template>${accContent}</template></var-def>
						    		</if>
						    	</case>
						    </body>								
						</loop>
	           		</empty>
	           		<template><![CDATA[ <accessoires><accessoire>${accessoires}</accessoire></accessoires> ]]></template>
	            	<![CDATA[ </annonce> ]]>  	            		                	
	            </body>
	        </loop>					
		</while>		
		<![CDATA[ </annonces> ]]>    
	</file>			
</config>